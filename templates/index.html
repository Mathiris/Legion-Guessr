<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <title>Wiki Guess Game - L√©gion d'Honneur</title>
</head>
<body>
    <div id="person-name">
        <h1>{{ name|replace('_', ' ') }}</h1>
    </div>
    <div id="content">
        <div class="image">
            <img id="person-image" alt="Image de la personnalit√©">
        </div>
        <div class="description">
            <p id="person-description" class="collapsed"></p>
            <button id="toggle-description">Afficher plus</button>
        </div>        

        <div id="popup" style="display: none;">
            <div id="popup-content">
                <h2>üéâ Bravo !</h2>
                <p>Vous avez correctement r√©pondu !</p>
                <button id="popup-continue">Continuer</button>
            </div>
        </div>

        <div id="popup-defeat" style="display: none;">
            <div id="popup-content-defeat">
                <h2>üòû Mauvaise r√©ponse</h2>
                <p>Ce n'√©tait pas la bonne r√©ponse, mais vous pouvez r√©essayer !</p>
                <p id="vote-result"></p> 
                <button id="popup-try-again">R√©essayer</button>
            </div>
        </div>
        <script>
            document.getElementById("popup-try-again").addEventListener("click", function () {
                // Rafra√Æchit la page pour permettre un nouvel essai
                location.reload();
            });

        </script>

        <script>
            document.getElementById("toggle-description").addEventListener("click", function () {
                const description = document.getElementById("person-description");
                const isCollapsed = description.classList.contains("collapsed");
        
                if (isCollapsed) {
                    description.classList.remove("collapsed");
                    this.textContent = "Afficher moins";
                } else {
                    description.classList.add("collapsed");
                    this.textContent = "Afficher plus";
                }
            });
        </script>
        <div class="vote-section">
            <h2>Pensez-vous que cette personnalit√© a la L√©gion d'Honneur ?</h2>
            <button id="vote-yes">Oui</button>
            <button id="vote-no">Non</button>
            <p id="vote-result"></p>
            <button id="continue-button" style="display: none;">Continue</button>
        </div>
        <div id="streak">Streak: 0</div>
    </div>

    <script>
        // Ces valeurs viennent de Flask
        const personName = "{{ name }}";  // Nom et pr√©nom de la personnalit√©
        const hasLegionHonor = {{ has_legion_honneur | tojson }};  // true ou false

        // Fonction pour r√©cup√©rer les donn√©es de l'API Wikip√©dia
        async function fetchWikipediaData(personName) {
            try {
                const response = await fetch(
                    `https://fr.wikipedia.org/w/api.php?action=query&format=json&prop=extracts|pageimages&titles=${encodeURIComponent(personName)}&exintro=true&explaintext=true&piprop=thumbnail&pithumbsize=500&origin=*`
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                const page = pages[pageId];

                // Extraire les donn√©es n√©cessaires
                const description = page.extract || "Aucune description disponible.";
                const imageUrl = page.thumbnail?.source || "";

                // Injecter dans le DOM
                document.getElementById("person-description").textContent = description;
                const imgElement = document.getElementById("person-image");
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    imgElement.alt = `Image de ${personName}`;
                } else {
                    imgElement.alt = "Image non disponible";
                }
            } catch (error) {
                console.error("Erreur lors de la r√©cup√©ration des donn√©es :", error);
                document.getElementById("person-description").textContent = "Une erreur est survenue.";
            }
        }

        // Fonction pour v√©rifier si la date actuelle est diff√©rente de la derni√®re date de changement
        function isNewDay() {
            const lastChangeDate = getLastChangeDate();
            const now = new Date();
            if (!lastChangeDate) return true;  // Si aucune date n'est d√©finie, c'est un nouveau jour

            const lastChangeDay = lastChangeDate.getDate();
            const currentDay = now.getDate();
            return lastChangeDay !== currentDay;
        }

        // Fonction pour r√©cup√©rer la date du dernier changement d'image
        function getLastChangeDate() {
            const date = localStorage.getItem("lastChangeDate");
            return date ? new Date(date) : null;
        }

        // Fonction pour mettre √† jour la date du dernier changement d'image
        function setLastChangeDate() {
            const currentDate = new Date();
            localStorage.setItem("lastChangeDate", currentDate.toISOString());
        }

        // Fonction pour v√©rifier si l'utilisateur a d√©j√† vot√©
        function hasUserVoted() {
            return localStorage.getItem("hasVoted") === "true";
        }

        // Fonction pour enregistrer le vote de l'utilisateur
        function setUserVoted() {
            localStorage.setItem("hasVoted", "true");
        }

        // Fonction pour g√©rer les votes
        function handleVote(isYes) {
            const isCorrect = isYes === hasLegionHonor;

            if (isCorrect) {
                // Affiche le pop-up de victoire
                document.getElementById("popup").style.display = "flex";
            } else {
                // R√©cup√©rer le streak actuel avant de perdre
                const currentStreak = getStreak();

                // Affiche le pop-up de d√©faite et affiche le streak
                document.getElementById("popup-defeat").style.display = "flex";
                document.getElementById("vote-result").textContent = `Votre score : ${currentStreak}`;
            }

            // D√©sactive les boutons de vote
            disableVoteButtons();

            // Met √† jour le streak
            updateStreak(isCorrect);
        }


        // √âv√©nement pour le bouton "Continuer"
        document.getElementById("popup-continue").addEventListener("click", function () {
            // Rafra√Æchit la page
            location.reload();
        });


        // Fonction pour d√©sactiver les boutons de vote
        function disableVoteButtons() {
            document.getElementById("vote-yes").disabled = true;
            document.getElementById("vote-no").disabled = true;
        }

        
        // Fonction pour r√©cup√©rer le streak de l'utilisateur
        function getStreak() {
            let streak = localStorage.getItem("streak");
            if (!streak) {
                streak = 0;
            }
            return streak;
        }

        // Fonction pour mettre √† jour le streak
        function updateStreak(isCorrect) {
            let streak = parseInt(localStorage.getItem("streak"), 10) || 0;

            if (isCorrect) {
                streak += 1;
            } else {
                streak = 0;
            }

            localStorage.setItem("streak", streak);
            document.getElementById("streak").textContent = `Streak: ${streak}`;
}


        // Fonction pour charger une nouvelle personnalit√© chaque jour
        function loadNewPersonalityIfNeeded() {
            const now = new Date();
            const lastChangeDate = getLastChangeDate();

            if (!lastChangeDate || isNewDay()) { // V√©rifie si c'est un nouveau jour ou la premi√®re fois
                // Remplacez la logique de la personnalit√© ici par votre propre logique al√©atoire ou fix√©e
                fetchWikipediaData(personName);  // Charger les donn√©es de la personnalit√©
                setLastChangeDate();  // Mettre √† jour la date du dernier changement
            } else {
                // Charge la m√™me personnalit√©
                fetchWikipediaData(personName);
            }
        }

        // √âcouteurs d'√©v√©nements pour les boutons
        document.getElementById("vote-yes").addEventListener("click", function() {
            handleVote(true);
        });

        document.getElementById("vote-no").addEventListener("click", function() {
            handleVote(false);
        });

        // Charger les donn√©es au chargement de la page
        loadNewPersonalityIfNeeded();

        // Afficher le streak actuel
        document.getElementById("streak").textContent = `Streak: ${getStreak()}`;
    </script>
</body>
</html>
